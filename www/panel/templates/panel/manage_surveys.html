{% extends 'panel/base.html' %}

{% block title %}師傅評論管理{% endblock %}

{% block extra_css %}
<style>
    .surveys-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #eee;
        padding-bottom: 15px;
    }
    
    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #333;
        margin: 0;
    }
    
    .filters-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .filters-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }
    
    .filters-row {
        display: flex;
        gap: 15px;
        align-items: end;
        flex-wrap: wrap;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }
    
    .filter-select {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        transition: border-color 0.3s ease;
    }
    
    .filter-select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-1px);
    }
    
    .btn-success {
        background: #28a745;
        color: white;
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .btn-success:hover {
        background: #218838;
        transform: translateY(-1px);
    }
    
    .surveys-table {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }
    
    .table th {
        background: #343a40;
        color: white;
        font-weight: 600;
        text-align: left;
        padding: 16px;
        border: none;
    }
    
    .table td {
        padding: 14px 16px;
        border-bottom: 1px solid #eee;
        vertical-align: top;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9ff;
    }
    
    .table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .rating-stars {
        display: flex;
        gap: 2px;
        align-items: center;
    }
    
    .star {
        width: 16px;
        height: 16px;
        fill: #ffc107;
    }
    
    .star.empty {
        fill: #e0e0e0;
    }
    
    .rating-text {
        margin-left: 8px;
        font-weight: 500;
        color: #333;
    }
    
    .comment-cell {
        max-width: 300px;
        word-wrap: break-word;
        line-height: 1.4;
    }
    
    .comment-text {
        color: #555;
    }
    
    .comment-empty {
        color: #999;
        font-style: italic;
    }
    
    .therapist-name {
        font-weight: 600;
        color: #007bff;
    }
    
    .date-text {
        color: #666;
        font-size: 13px;
    }
    
    .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 16px;
    }
    
    .no-data svg {
        width: 64px;
        height: 64px;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    .stats-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        padding: 20px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 14px;
        color: #666;
        font-weight: 500;
    }
    
    .stat-card.rating {
        background: linear-gradient(135deg, #ffc107, #ff8c00);
        color: white;
    }
    
    .stat-card.rating .stat-value {
        color: white;
    }
    
    .stat-card.rating .stat-label {
        color: rgba(255, 255, 255, 0.9);
    }
    
    /* Modal Styles for Survey Details */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        transform: scale(0.9);
        opacity: 0;
        transition: all 0.3s ease;
    }
    
    .modal.show .modal-content {
        transform: scale(1);
        opacity: 1;
    }
    
    .modal-header {
        background: #343a40;
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }
    
    .close {
        color: white;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.3s ease;
    }
    
    .close:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .modal-body {
        padding: 30px;
    }
    
    .survey-detail {
        margin-bottom: 20px;
    }
    
    .detail-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
        display: block;
    }
    
    .detail-value {
        color: #666;
        line-height: 1.5;
    }
    
    .large-rating {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 10px 0;
    }
    
    .large-rating .star {
        width: 24px;
        height: 24px;
    }
    
    .large-rating .rating-text {
        font-size: 18px;
        margin-left: 10px;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .surveys-container {
            padding: 10px;
        }
        
        .page-header {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }
        
        .filters-row {
            flex-direction: column;
        }
        
        .filter-group {
            min-width: unset;
        }
        
        .stats-section {
            grid-template-columns: 1fr;
        }
        
        .table th,
        .table td {
            padding: 10px 8px;
            font-size: 14px;
        }
        
        .comment-cell {
            max-width: 200px;
        }
        
        .modal-content {
            margin: 10% auto;
            width: 95%;
        }
        
        .modal-body {
            padding: 20px;
        }
    }
    
    @media (max-width: 480px) {
        .table th:nth-child(3),
        .table td:nth-child(3) {
            display: none;
        }
        
        .comment-cell {
            max-width: 150px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="surveys-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">師傅評論管理</h1>
        <button class="btn btn-primary" onclick="openModal('add')">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            新增評論
        </button>
    </div>

    <!-- Statistics Section -->
    <div class="stats-section">
        <div class="stat-card">
            <div class="stat-value" id="totalSurveys">{{ surveys|length }}</div>
            <div class="stat-label">總評論數</div>
        </div>
        <div class="stat-card rating">
            <div class="stat-value" id="avgRating">-</div>
            <div class="stat-label">平均評分</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalTherapists">{{ therapists|length }}</div>
            <div class="stat-label">師傅總數</div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <h3 class="filters-title">篩選條件</h3>
        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label" for="therapistFilter">選擇師傅</label>
                <select class="filter-select" id="therapistFilter" onchange="filterSurveys()">
                    <option value="">全部師傅</option>
                    {% for therapist in therapists %}
                    <option value="{{ therapist.id }}">{{ therapist.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label" for="ratingFilter">評分篩選</label>
                <select class="filter-select" id="ratingFilter" onchange="filterSurveys()">
                    <option value="">全部評分</option>
                    <option value="5">5 星</option>
                    <option value="4">4 星</option>
                    <option value="3">3 星</option>
                    <option value="2">2 星</option>
                    <option value="1">1 星</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="btn btn-secondary" onclick="clearFilters()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                    </svg>
                    清除篩選
                </button>
            </div>
        </div>
    </div>

    <!-- Surveys Table -->
    <div class="surveys-table">
        <table class="table">
            <thead>
                <tr>
                    <th>師傅</th>
                    <th>評分</th>
                    <th>評論內容</th>
                    <th>評論時間</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="surveysTableBody">
                {% for survey in surveys %}
                <tr data-therapist="{{ survey.therapist.id }}" data-rating="{{ survey.rating }}">
                    <td>
                        <span class="therapist-name">{{ survey.therapist.name }}</span>
                    </td>
                    <td>
                        <div class="rating-stars">
                            {% for i in "12345" %}
                                {% if forloop.counter <= survey.rating %}
                                    <svg class="star" viewBox="0 0 16 16">
                                        <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                                    </svg>
                                {% else %}
                                    <svg class="star empty" viewBox="0 0 16 16">
                                        <path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.283.95l3.523 3.356-.83 4.73zm4.905-2.767-3.686 1.894.694-3.957a.565.565 0 0 0-.163-.505L1.71 6.745l4.052-.576a.525.525 0 0 0 .393-.288L8 2.223l1.847 3.658a.525.525 0 0 0 .393.288l4.052.575-2.906 2.77a.565.565 0 0 0-.163.506l.694 3.957-3.686-1.894a.503.503 0 0 0-.461 0z"/>
                                    </svg>
                                {% endif %}
                            {% endfor %}
                            <span class="rating-text">{{ survey.rating }}/5</span>
                        </div>
                    </td>
                    <td class="comment-cell">
                        {% if survey.comment %}
                            <span class="comment-text">{{ survey.comment }}</span>
                        {% else %}
                            <span class="comment-empty">無評論內容</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="date-text">{{ survey.created_at|date:"Y-m-d H:i" }}</span>
                    </td>
                    <td>
                        <button class="btn btn-success" onclick="viewSurveyDetails({{ survey.id }}, '{{ survey.therapist.name|escapejs }}', {{ survey.rating }}, '{{ survey.comment|escapejs }}', '{{ survey.created_at|date:"Y-m-d H:i" }}')">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                            </svg>
                            查看
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="no-data">
                        <svg fill="currentColor" viewBox="0 0 16 16">
                            <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                            <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                        </svg>
                        <div>目前還沒有評論資料</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Survey Detail Modal -->
<div id="surveyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">評論詳情</h2>
            <button class="close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="survey-detail">
                <span class="detail-label">師傅姓名</span>
                <div class="detail-value" id="modalTherapistName"></div>
            </div>
            
            <div class="survey-detail">
                <span class="detail-label">評分</span>
                <div class="large-rating" id="modalRating"></div>
            </div>
            
            <div class="survey-detail">
                <span class="detail-label">評論內容</span>
                <div class="detail-value" id="modalComment"></div>
            </div>
            
            <div class="survey-detail">
                <span class="detail-label">評論時間</span>
                <div class="detail-value" id="modalDate"></div>
            </div>
        </div>
    </div>
</div>

<!-- Add Survey Modal -->
<div id="addSurveyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">新增評論</h2>
            <button class="close" onclick="closeAddModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="surveyForm">
                {% csrf_token %}
                <div class="survey-detail">
                    <label class="detail-label" for="therapistSelect">選擇師傅 *</label>
                    <select class="filter-select" id="therapistSelect" name="therapist" required>
                        <option value="">請選擇師傅</option>
                        {% for therapist in therapists %}
                        <option value="{{ therapist.id }}">{{ therapist.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="survey-detail">
                    <label class="detail-label" for="ratingSelect">評分 *</label>
                    <select class="filter-select" id="ratingSelect" name="rating" required>
                        <option value="">請選擇評分</option>
                        <option value="5">5 星 - 非常滿意</option>
                        <option value="4">4 星 - 滿意</option>
                        <option value="3">3 星 - 普通</option>
                        <option value="2">2 星 - 不滿意</option>
                        <option value="1">1 星 - 非常不滿意</option>
                    </select>
                </div>
                
                <div class="survey-detail">
                    <label class="detail-label" for="commentInput">評論內容</label>
                    <textarea class="filter-select" id="commentInput" name="comment" rows="4" placeholder="請輸入評論內容..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer" style="padding: 20px 30px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" onclick="closeAddModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="saveSurvey()">儲存評論</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// CSRF Token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Calculate and display average rating
function calculateStats() {
    const rows = document.querySelectorAll('#surveysTableBody tr[data-rating]');
    if (rows.length === 0) {
        document.getElementById('avgRating').textContent = '-';
        return;
    }
    
    let totalRating = 0;
    rows.forEach(row => {
        const rating = parseInt(row.getAttribute('data-rating'));
        totalRating += rating;
    });
    
    const avgRating = (totalRating / rows.length).toFixed(1);
    document.getElementById('avgRating').textContent = avgRating;
}

// Filter surveys
function filterSurveys() {
    const therapistFilter = document.getElementById('therapistFilter').value;
    const ratingFilter = document.getElementById('ratingFilter').value;
    const rows = document.querySelectorAll('#surveysTableBody tr[data-therapist]');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const therapistId = row.getAttribute('data-therapist');
        const rating = row.getAttribute('data-rating');
        
        let show = true;
        
        if (therapistFilter && therapistId !== therapistFilter) {
            show = false;
        }
        
        if (ratingFilter && rating !== ratingFilter) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    // Update total count
    document.getElementById('totalSurveys').textContent = visibleCount;
    
    // Show/hide no data message
    const noDataRow = document.querySelector('#surveysTableBody tr:last-child');
    if (visibleCount === 0 && noDataRow && noDataRow.children.length === 1) {
        noDataRow.style.display = '';
    } else if (noDataRow && noDataRow.children.length === 1) {
        noDataRow.style.display = 'none';
    }
}

// Clear filters
function clearFilters() {
    document.getElementById('therapistFilter').value = '';
    document.getElementById('ratingFilter').value = '';
    filterSurveys();
    calculateStats();
}

// View survey details
function viewSurveyDetails(id, therapistName, rating, comment, date) {
    document.getElementById('modalTherapistName').textContent = therapistName;
    document.getElementById('modalComment').textContent = comment || '無評論內容';
    document.getElementById('modalDate').textContent = date;
    
    // Create rating stars
    const ratingContainer = document.getElementById('modalRating');
    ratingContainer.innerHTML = '';
    
    for (let i = 1; i <= 5; i++) {
        const star = document.createElement('svg');
        star.className = i <= rating ? 'star' : 'star empty';
        star.setAttribute('viewBox', '0 0 16 16');
        star.innerHTML = '<path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>';
        ratingContainer.appendChild(star);
    }
    
    const ratingText = document.createElement('span');
    ratingText.className = 'rating-text';
    ratingText.textContent = `${rating}/5`;
    ratingContainer.appendChild(ratingText);
    
    const modal = document.getElementById('surveyModal');
    modal.style.display = 'block';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
}

// Close modal
function closeModal() {
    const modal = document.getElementById('surveyModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

// Add survey modal functions
function openModal(mode) {
    if (mode === 'add') {
        const modal = document.getElementById('addSurveyModal');
        const form = document.getElementById('surveyForm');
        form.reset();
        
        modal.style.display = 'block';
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
        
        document.getElementById('therapistSelect').focus();
    }
}

function closeAddModal() {
    const modal = document.getElementById('addSurveyModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

function showLoading(button) {
    button.disabled = true;
    const originalText = button.innerHTML;
    button.setAttribute('data-original-text', originalText);
    button.innerHTML = '<svg class="animate-spin" width="16" height="16" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> 處理中...';
}

function hideLoading(button) {
    button.disabled = false;
    const originalText = button.getAttribute('data-original-text');
    button.innerHTML = originalText || '儲存評論';
}

function saveSurvey() {
    const form = document.getElementById('surveyForm');
    const saveButton = document.querySelector('#addSurveyModal .btn-primary');
    
    // Validate form
    const therapistSelect = document.getElementById('therapistSelect');
    const ratingSelect = document.getElementById('ratingSelect');
    
    if (!therapistSelect.value) {
        alert('請選擇師傅');
        therapistSelect.focus();
        return;
    }
    
    if (!ratingSelect.value) {
        alert('請選擇評分');
        ratingSelect.focus();
        return;
    }
    
    showLoading(saveButton);
    
    const formData = new FormData(form);
    const data = {
        therapist: parseInt(formData.get('therapist')),
        rating: parseInt(formData.get('rating')),
        comment: formData.get('comment').trim()
    };

    fetch('/api/service-surveys/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        return response.text().then(text => {
            throw new Error(`HTTP ${response.status}: ${text}`);
        });
    })
    .then(data => {
        hideLoading(saveButton);
        closeAddModal();
        showSuccessMessage('評論新增成功！');
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    })
    .catch(error => {
        console.error('Error:', error);
        hideLoading(saveButton);
        alert('儲存失敗：' + error.message);
    });
}

function showSuccessMessage(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        z-index: 1001;
        animation: slideIn 0.3s ease;
    `;
    
    toast.innerHTML = `
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
        </svg>
        ${message}
    `;
    
    // Add animation styles if not already added
    if (!document.querySelector('style[data-toast-animations]')) {
        const style = document.createElement('style');
        style.setAttribute('data-toast-animations', 'true');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .animate-spin {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    calculateStats();
    
    // Close modals when clicking outside
    window.onclick = function(event) {
        const surveyModal = document.getElementById('surveyModal');
        const addSurveyModal = document.getElementById('addSurveyModal');
        
        if (event.target == surveyModal) {
            closeModal();
        }
        if (event.target == addSurveyModal) {
            closeAddModal();
        }
    }

    // Close modals with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
            closeAddModal();
        }
    });

    // Form submission with Enter key
    const form = document.getElementById('surveyForm');
    if (form) {
        form.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                saveSurvey();
            }
        });
    }
});
</script>
{% endblock %}
