{% extends 'panel/base.html' %}

{% block title %}é‚€è«‹ç®¡ç†{% endblock %}

{% block extra_css %}
<style>
    .invitations-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #eee;
        padding-bottom: 15px;
    }
    
    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #333;
        margin: 0;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-1px);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        color: white;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
    }
    
    .btn-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
    }
    
    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    }
    
    .btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
    }
    
    .btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
    }
    
    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    /* Statistics Section */
    .stats-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        padding: 25px;
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--card-color);
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card.today {
        --card-color: #28a745;
    }
    
    .stat-card.upcoming {
        --card-color: #007bff;
    }
    
    .stat-card.total {
        --card-color: #6f42c1;
    }
    
    .stat-card.clicks {
        --card-color: #ffc107;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--card-color);
    }
    
    .stat-label {
        font-size: 14px;
        color: #666;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Filters Section */
    .filters-section {
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        padding: 25px;
        margin-bottom: 25px;
    }
    
    .filters-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .filters-title::before {
        content: 'ğŸ”';
        font-size: 20px;
    }
    
    .filters-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        align-items: end;
        margin-bottom: 20px;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    
    .filter-label {
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }
    
    .filter-input,
    .filter-select {
        padding: 12px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: white;
    }
    
    .filter-input:focus,
    .filter-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .quick-filters {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    .quick-filter-btn {
        padding: 10px 18px;
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .quick-filter-btn:hover,
    .quick-filter-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    /* Invitations Grid */
    .invitations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        gap: 25px;
    }
    
    .invitation-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        padding: 25px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }
    
    .invitation-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--status-color);
        transition: height 0.3s ease;
    }
    
    .invitation-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        border-color: var(--status-color);
    }
    
    .invitation-card:hover::before {
        height: 8px;
    }
    
    .invitation-card.today {
        --status-color: #28a745;
    }
    
    .invitation-card.upcoming {
        --status-color: #007bff;
    }
    
    .invitation-card.past {
        --status-color: #6c757d;
        opacity: 0.7;
    }
    
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }
    
    .card-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    .card-therapist {
        color: #6f42c1;
        font-weight: 600;
        font-size: 1rem;
    }
    
    .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: white;
        background: var(--status-color);
    }
    
    .card-details {
        margin-bottom: 20px;
    }
    
    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding: 10px 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .detail-row:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }
    
    .detail-value {
        color: #2c3e50;
        font-weight: 500;
        text-align: right;
    }
    
    .price-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        position: relative;
    }
    
    .price-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .original-price {
        text-decoration: line-through;
        color: #6c757d;
        font-size: 16px;
    }
    
    .discount-price {
        font-size: 1.8rem;
        font-weight: 700;
        color: #e74c3c;
    }
    
    .savings-badge {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stats-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 12px;
    }
    
    .click-count {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: #495057;
    }
    
    .availability-status {
        font-size: 13px;
        color: #6c757d;
        font-weight: 500;
    }
    
    .card-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
    }
    
    .card-actions .btn {
        flex: 1;
    }
    
    .invitation-url-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .url-display {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .url-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 12px;
        color: #495057;
        background: white;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        flex: 1;
        word-break: break-all;
    }
    
    .copy-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .copy-btn:hover {
        background: #218838;
        transform: translateY(-1px);
    }
    
    .copy-btn.copied {
        background: #17a2b8;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
    }
    
    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal-content {
        background-color: white;
        padding: 0;
        border-radius: 20px;
        width: 90%;
        max-width: 700px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        transform: scale(0.9);
        opacity: 0;
        transition: all 0.3s ease;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal.show .modal-content {
        transform: scale(1);
        opacity: 1;
        animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
        from {
            transform: translateY(50px) scale(0.9);
        }
        to {
            transform: translateY(0) scale(1);
        }
    }
    
    .modal-header {
        background: linear-gradient(135deg, #343a40, #495057);
        color: white;
        padding: 25px 30px;
        border-radius: 20px 20px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }
    
    .close {
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    
    .close:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
    }
    
    .modal-body {
        padding: 30px;
    }
    
    .form-group {
        margin-bottom: 25px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }
    
    .required {
        color: #dc3545;
    }
    
    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s ease;
        box-sizing: border-box;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-control.textarea {
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    
    .form-row.three-col {
        grid-template-columns: 2fr 1fr 1fr;
    }
    
    .form-col-full {
        grid-column: 1 / -1;
    }
    
    .modal-footer {
        padding: 20px 30px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        background: #f8f9fa;
        border-radius: 0 0 20px 20px;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        grid-column: 1 / -1;
    }
    
    .empty-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .empty-title {
        font-size: 24px;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 10px;
    }
    
    .empty-text {
        color: #adb5bd;
        margin-bottom: 25px;
        line-height: 1.6;
    }
    
    /* Loading Animation */
    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Success Message */
    .success-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        z-index: 1001;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }
    
    .success-toast.show {
        transform: translateX(0);
    }
    
    /* QR Code Modal */
    .qr-section {
        text-align: center;
        margin: 20px 0;
    }
    
    .qr-code-container {
        display: inline-block;
        padding: 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .invitations-container {
            padding: 15px;
        }
        
        .page-header {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }
        
        .stats-section {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .filters-row {
            grid-template-columns: 1fr;
        }
        
        .invitations-grid {
            grid-template-columns: 1fr;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .form-row.three-col {
            grid-template-columns: 1fr;
        }
        
        .modal-content {
            margin: 10px;
            width: calc(100% - 20px);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .card-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .card-actions .btn {
            width: 100%;
        }
    }
    
    @media (max-width: 480px) {
        .stats-section {
            grid-template-columns: 1fr;
        }
        
        .quick-filters {
            justify-content: center;
        }
        
        .btn {
            font-size: 12px;
            padding: 8px 16px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="invitations-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">ğŸ“¨ é‚€è«‹ç®¡ç†</h1>
        <button class="btn btn-primary" onclick="openCreateModal()">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            å»ºç«‹é‚€è«‹
        </button>
    </div>

    <!-- Statistics Section -->
    <div class="stats-section">
        <div class="stat-card today">
            <div class="stat-value" id="todayCount">0</div>
            <div class="stat-label">ä»Šæ—¥å¯é ç´„</div>
        </div>
        <div class="stat-card upcoming">
            <div class="stat-value" id="upcomingCount">0</div>
            <div class="stat-label">æœªä¾†å¯é ç´„</div>
        </div>
        <div class="stat-card total">
            <div class="stat-value" id="totalCount">{{ invitations|length }}</div>
            <div class="stat-label">ç¸½é‚€è«‹æ•¸</div>
        </div>
        <div class="stat-card clicks">
            <div class="stat-value" id="totalClicks">0</div>
            <div class="stat-label">ç¸½é»æ“Šæ•¸</div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <h3 class="filters-title">æœå°‹èˆ‡ç¯©é¸</h3>
        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label" for="therapistFilter">å¸«å‚…</label>
                <select class="filter-select" id="therapistFilter" onchange="applyFilters()">
                    <option value="">å…¨éƒ¨å¸«å‚…</option>
                    {% for therapist in therapists %}
                    <option value="{{ therapist.id }}">{{ therapist.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label" for="planFilter">æ–¹æ¡ˆ</label>
                <select class="filter-select" id="planFilter" onchange="applyFilters()">
                    <option value="">å…¨éƒ¨æ–¹æ¡ˆ</option>
                    {% for plan in massage_plans %}
                    <option value="{{ plan.id }}">{{ plan.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label" for="startDateFilter">æœå‹™æ—¥æœŸèµ·</label>
                <input type="date" class="filter-input" id="startDateFilter" onchange="applyFilters()">
            </div>
            <div class="filter-group">
                <label class="filter-label" for="endDateFilter">æœå‹™æ—¥æœŸè¿„</label>
                <input type="date" class="filter-input" id="endDateFilter" onchange="applyFilters()">
            </div>
        </div>
        
        <div class="quick-filters">
            <span class="quick-filter-btn active" onclick="quickFilter('all')">å…¨éƒ¨é‚€è«‹</span>
            <span class="quick-filter-btn" onclick="quickFilter('today')">ä»Šæ—¥å¯é ç´„</span>
            <span class="quick-filter-btn" onclick="quickFilter('upcoming')">æœªä¾†å¯é ç´„</span>
            <span class="quick-filter-btn" onclick="quickFilter('past')">å·²éæœŸ</span>
            <button class="btn btn-secondary" onclick="clearFilters()" style="margin-left: auto;">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                </svg>
                æ¸…é™¤ç¯©é¸
            </button>
        </div>
    </div>

    <!-- Invitations Grid -->
    <div id="invitationsContainer">
        <div class="invitations-grid" id="invitationsGrid">
            {% for invitation in invitations %}
            <div class="invitation-card" 
                 data-id="{{ invitation.id }}"
                 data-therapist="{{ invitation.therapist.id }}" 
                 data-plan="{{ invitation.massage_plan.id }}"
                 data-start-date="{{ invitation.available_start|date:'Y-m-d' }}"
                 data-end-date="{{ invitation.available_end|date:'Y-m-d' }}"
                 data-start-datetime="{{ invitation.available_start|date:'c' }}"
                 data-end-datetime="{{ invitation.available_end|date:'c' }}">
                
                <div class="card-header">
                    <div>
                        <div class="card-title">{{ invitation.massage_plan.name }}</div>
                        <div class="card-therapist">{{ invitation.therapist.name }}</div>
                    </div>
                    <span class="status-badge" id="status-{{ invitation.id }}">æª¢æŸ¥ä¸­</span>
                </div>

                <div class="card-details">
                    <div class="detail-row">
                        <span class="detail-label">ğŸ‘¨â€âš•ï¸ å¯æœå‹™æ™‚é–“</span>
                        <span class="detail-value">
                            {{ invitation.available_start|date:"m/d H:i" }} - {{ invitation.available_end|date:"m/d H:i" }}
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">â±ï¸ ç™‚ç¨‹æ™‚é–“</span>
                        <span class="detail-value">{{ invitation.massage_plan.name }} {{ invitation.massage_plan.duration }} åˆ†é˜</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ğŸ“… æœå‹™æ—¥æœŸ</span>
                        <span class="detail-value">{{ invitation.available_start|date:"Y/m/d (l)" }}</span>
                    </div>
                    {% if invitation.notes %}
                    <div class="detail-row">
                        <span class="detail-label">ğŸ“ å‚™è¨»</span>
                        <span class="detail-value">{{ invitation.notes }}</span>
                    </div>
                    {% endif %}
                </div>

                <div class="price-section">
                    <div class="price-row">
                        <div>
                            <div class="original-price">åŸåƒ¹ ${{ invitation.massage_plan.price|floatformat:0 }}</div>
                            <div class="discount-price">${{ invitation.discount_price|floatformat:0 }}</div>
                        </div>
                        <div class="savings-badge" data-original="{{ invitation.massage_plan.price }}" data-discount="{{ invitation.discount_price }}">
                            çœ $<span class="savings-amount"></span>
                        </div>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="click-count">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                            <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                        </svg>
                        {{ invitation.click_count }} æ¬¡é»æ“Š
                    </div>
                    <div class="availability-status" id="availability-{{ invitation.id }}">è¨ˆç®—ä¸­</div>
                </div>

                <div class="invitation-url-section">
                    <div class="url-display">
                        <input type="text" class="url-text" id="url-{{ invitation.id }}" 
                               value="{{ request.get_host }}/invitation/{{ invitation.slug }}/" readonly>
                        <button class="copy-btn" onclick="copyInvitationUrl('{{ invitation.slug }}', {{ invitation.id }})">
                            è¤‡è£½
                        </button>
                    </div>
                </div>

                <div class="card-actions">
                    <button class="btn btn-success" onclick="editInvitation({{ invitation.id }})">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708L9.708 9H9a.5.5 0 0 1-.5-.5v-.708l5.146-5.146z"/>
                            <path fill-rule="evenodd" d="M3 5a2 2 0 0 1 2-2h1.586l2 2H5a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V9.414l2-2V11a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5z"/>
                        </svg>
                        ç·¨è¼¯
                    </button>
                    <button class="btn btn-danger" onclick="deleteInvitation({{ invitation.id }}, '{{ invitation.massage_plan.name|escapejs }}')">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                        åˆªé™¤
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-icon">ğŸ“¨</div>
                <div class="empty-title">å°šç„¡é‚€è«‹</div>
                <div class="empty-text">
                    é‚„æ²’æœ‰ä»»ä½•æŒ‰æ‘©é‚€è«‹<br>
                    é»æ“Šä¸Šæ–¹ã€Œå»ºç«‹é‚€è«‹ã€ä¾†å‰µå»ºç¬¬ä¸€å€‹é‚€è«‹å§ï¼
                </div>
                <button class="btn btn-primary" onclick="openCreateModal()">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    å»ºç«‹ç¬¬ä¸€å€‹é‚€è«‹
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="invitationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">å»ºç«‹æŒ‰æ‘©é‚€è«‹</h2>
            <button class="close" onclick="closeModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <form id="invitationForm">
                {% csrf_token %}
                <input type="hidden" id="invitationId" name="id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="massagePlan">
                            æŒ‰æ‘©æ–¹æ¡ˆ <span class="required">*</span>
                        </label>
                        <select class="form-control" id="massagePlan" name="massage_plan" required>
                            <option value="">è«‹é¸æ“‡æ–¹æ¡ˆ</option>
                            {% for plan in massage_plans %}
                            <option value="{{ plan.id }}" data-price="{{ plan.price }}" data-duration="{{ plan.duration }}">
                                {{ plan.name }} - ${{ plan.price|floatformat:0 }} ({{ plan.duration }}åˆ†é˜)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="therapist">
                            æŒ‡å®šå¸«å‚… <span class="required">*</span>
                        </label>
                        <select class="form-control" id="therapist" name="therapist" required>
                            <option value="">è«‹é¸æ“‡å¸«å‚…</option>
                            {% for therapist in therapists %}
                            <option value="{{ therapist.id }}">{{ therapist.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-row three-col">
                    <div class="form-group">
                        <label class="form-label" for="invitationDate">
                            å¸«å‚…å¯æœå‹™æ—¥æœŸ <span class="required">*</span>
                        </label>
                        <input type="date" class="form-control" id="invitationDate" name="invitation_date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="startTime">
                            å¯æœå‹™é–‹å§‹æ™‚é–“ <span class="required">*</span>
                        </label>
                        <input type="time" class="form-control" id="startTime" name="available_start" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="endTime">
                            å¯æœå‹™çµæŸæ™‚é–“ <span class="required">*</span>
                        </label>
                        <input type="time" class="form-control" id="endTime" name="available_end" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="originalPrice">åŸåƒ¹</label>
                        <input type="number" class="form-control" id="originalPrice" name="original_price" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="discountPrice">
                            ç‰¹åƒ¹ <span class="required">*</span>
                        </label>
                        <input type="number" class="form-control" id="discountPrice" name="discount_price" required min="1" step="1" placeholder="è¼¸å…¥ç‰¹åƒ¹é‡‘é¡">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="savingsDisplay">ç¯€çœé‡‘é¡</label>
                    <input type="text" class="form-control" id="savingsDisplay" readonly style="background: #f8f9fa;" placeholder="å°‡è‡ªå‹•è¨ˆç®—">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="notes">å‚™è¨»</label>
                    <textarea class="form-control textarea" id="notes" name="notes" placeholder="é‚€è«‹èªªæ˜ã€æ³¨æ„äº‹é …ç­‰..."></textarea>
                </div>
            </form>
        </div>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="saveInvitation()" id="saveBtn">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                å»ºç«‹é‚€è«‹
            </button>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
// Global variables
let isEditMode = false;
let currentInvitationId = null;

// CSRF Token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Modal functions
function openCreateModal() {
    console.log('openCreateModal called');
    const modal = document.getElementById('invitationModal');
    const modalTitle = document.getElementById('modalTitle');
    const form = document.getElementById('invitationForm');
    const saveBtn = document.getElementById('saveBtn');
    
    if (!modal) {
        console.error('Modal element not found');
        return;
    }
    
    modalTitle.textContent = 'å»ºç«‹æŒ‰æ‘©é‚€è«‹';
    form.reset();
    isEditMode = false;
    currentInvitationId = null;
    document.getElementById('invitationId').value = '';
    setDefaultDateTime();
    
    saveBtn.innerHTML = `
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
        </svg>
        å»ºç«‹é‚€è«‹
    `;
    
    modal.classList.add('show');
    setTimeout(() => {
        const massagePlanEl = document.getElementById('massagePlan');
        if (massagePlanEl) {
            massagePlanEl.focus();
        }
    }, 100);
}

function closeModal() {
    const modal = document.getElementById('invitationModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    
    updateStatusBadges();
    updateStatsCounts();
    calculateSavings();
    setDefaultDateTime();
    setupFormHandlers();
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    const invitationDateEl = document.getElementById('invitationDate');
    if (invitationDateEl) {
        invitationDateEl.min = today;
    }
    
    // Update status every minute
    setInterval(updateStatusBadges, 60000);
    
    // Setup modal event listeners
    setupModalEventListeners();
});

// Setup modal event listeners
function setupModalEventListeners() {
    // Close modals when clicking outside
    window.onclick = function(event) {
        const invitationModal = document.getElementById('invitationModal');
        
        if (event.target === invitationModal) {
            closeModal();
        }
    }

    // Close modals with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });

    // Form submission with Enter key
    const form = document.getElementById('invitationForm');
    if (form) {
        form.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey && event.target.tagName !== 'TEXTAREA') {
                event.preventDefault();
                saveInvitation();
            }
        });
    }
}

// Calculate savings for all cards
function calculateSavings() {
    document.querySelectorAll('.savings-badge[data-original]').forEach(badge => {
        const original = parseFloat(badge.getAttribute('data-original'));
        const discount = parseFloat(badge.getAttribute('data-discount'));
        const savings = original - discount;
        const savingsAmountEl = badge.querySelector('.savings-amount');
        if (savingsAmountEl) {
            savingsAmountEl.textContent = savings.toFixed(0);
        }
    });
}

// Update status badges and card styles
function updateStatusBadges() {
    const now = new Date();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    document.querySelectorAll('.invitation-card[data-start-datetime]').forEach(card => {
        const startTime = new Date(card.getAttribute('data-start-datetime'));
        const endTime = new Date(card.getAttribute('data-end-datetime'));
        const invitationId = card.getAttribute('data-id');
        const statusBadge = document.getElementById(`status-${invitationId}`);
        const availabilityEl = document.getElementById(`availability-${invitationId}`);
        
        let status, statusClass, availability;
        
        // Remove existing status classes
        card.classList.remove('today', 'upcoming', 'past');
        
        // Check if the service date is today, future, or past
        if (startTime >= today && startTime < tomorrow) {
            // Service is available today
            status = 'ä»Šæ—¥å¯é ç´„';
            statusClass = 'today';
            card.classList.add('today');
            
            if (now < startTime) {
                const diffMinutes = Math.floor((startTime - now) / (1000 * 60));
                availability = formatTimeRemaining(diffMinutes, 'å¾Œé–‹å§‹');
            } else if (now >= startTime && now <= endTime) {
                const diffMinutes = Math.floor((endTime - now) / (1000 * 60));
                availability = `å‰©é¤˜ ${formatTimeRemaining(diffMinutes)}`;
            } else {
                availability = 'ä»Šæ—¥æ™‚æ®µå·²çµæŸ';
            }
        } else if (startTime >= tomorrow) {
            // Service is in the future
            status = 'æœªä¾†å¯é ç´„';
            statusClass = 'upcoming';
            card.classList.add('upcoming');
            
            const daysUntil = Math.floor((startTime - now) / (1000 * 60 * 60 * 24));
            if (daysUntil === 1) {
                availability = 'æ˜å¤©';
            } else if (daysUntil <= 7) {
                availability = `${daysUntil} å¤©å¾Œ`;
            } else {
                availability = startTime.toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' });
            }
        } else {
            // Service date has passed
            status = 'å·²éæœŸ';
            statusClass = 'past';
            card.classList.add('past');
            availability = 'æ™‚æ®µå·²é';
        }
        
        if (statusBadge) {
            statusBadge.textContent = status;
        }
        if (availabilityEl) {
            availabilityEl.textContent = availability;
        }
    });
}

// Format time remaining
function formatTimeRemaining(minutes, suffix = '') {
    if (minutes < 60) {
        return `${minutes} åˆ†é˜${suffix}`;
    } else if (minutes < 1440) {
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = minutes % 60;
        if (remainingMinutes === 0) {
            return `${hours} å°æ™‚${suffix}`;
        }
        return `${hours} å°æ™‚ ${remainingMinutes} åˆ†é˜${suffix}`;
    } else {
        const days = Math.floor(minutes / 1440);
        const remainingHours = Math.floor((minutes % 1440) / 60);
        if (remainingHours === 0) {
            return `${days} å¤©${suffix}`;
        }
        return `${days} å¤© ${remainingHours} å°æ™‚${suffix}`;
    }
}

// Update statistics counts
function updateStatsCounts() {
    const now = new Date();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    let todayCount = 0;
    let upcomingCount = 0;
    let totalClicks = 0;
    
    document.querySelectorAll('.invitation-card[data-start-datetime]').forEach(card => {
        const startTime = new Date(card.getAttribute('data-start-datetime'));
        
        // Get click count from the card
        const clickElement = card.querySelector('.click-count');
        if (clickElement) {
            const clickText = clickElement.textContent.trim();
            const clickMatch = clickText.match(/(\d+)/);
            if (clickMatch) {
                totalClicks += parseInt(clickMatch[1]);
            }
        }
        
        // Count today's available services
        if (startTime >= today && startTime < tomorrow) {
            todayCount++;
        } 
        // Count future services
        else if (startTime >= tomorrow) {
            upcomingCount++;
        }
    });
    
    document.getElementById('todayCount').textContent = todayCount;
    document.getElementById('upcomingCount').textContent = upcomingCount;
    document.getElementById('totalClicks').textContent = totalClicks;
}

// Set default date and time
function setDefaultDateTime() {
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    document.getElementById('invitationDate').value = tomorrow.toISOString().split('T')[0];
    document.getElementById('startTime').value = '09:00';
    document.getElementById('endTime').value = '18:00';
}

// Setup form event handlers
function setupFormHandlers() {
    // Plan selection handler
    document.getElementById('massagePlan').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const price = selectedOption.getAttribute('data-price');
        
        if (price) {
            document.getElementById('originalPrice').value = parseFloat(price).toFixed(0);
            updateSavings();
        } else {
            document.getElementById('originalPrice').value = '';
            document.getElementById('savingsDisplay').value = '';
        }
    });
    
    // Discount price handler
    document.getElementById('discountPrice').addEventListener('input', updateSavings);
}

// Update savings calculation
function updateSavings() {
    const originalPriceText = document.getElementById('originalPrice').value;
    const discountPrice = parseFloat(document.getElementById('discountPrice').value) || 0;
    
    if (originalPriceText) {
        const originalPrice = parseFloat(originalPriceText.replace(/[,$\s]/g, '')) || 0;
        
        if (originalPrice > 0 && discountPrice > 0) {
            const savings = originalPrice - discountPrice;
            if (savings > 0) {
                document.getElementById('savingsDisplay').value = `çœ ${savings.toFixed(0)}`;
            } else if (savings === 0) {
                document.getElementById('savingsDisplay').value = 'ç„¡æŠ˜æ‰£';
            } else {
                document.getElementById('savingsDisplay').value = 'åƒ¹æ ¼ç•°å¸¸';
            }
        } else {
            document.getElementById('savingsDisplay').value = '';
        }
    }
}

// Edit invitation
function editInvitation(id) {
    fetch('/api/massage-invitations/' + id + '/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        const modal = document.getElementById('invitationModal');
        const modalTitle = document.getElementById('modalTitle');
        const saveBtn = document.getElementById('saveBtn');
        
        modalTitle.textContent = 'ç·¨è¼¯é‚€è«‹';
        
        // Fill form with existing data
        document.getElementById('invitationId').value = data.id;
        document.getElementById('massagePlan').value = data.massage_plan;
        document.getElementById('therapist').value = data.therapist;
        
        // Parse start and end times
        const startTime = new Date(data.available_start);
        const endTime = new Date(data.available_end);
        
        document.getElementById('invitationDate').value = startTime.toISOString().split('T')[0];
        document.getElementById('startTime').value = startTime.toTimeString().substring(0, 5);
        document.getElementById('endTime').value = endTime.toTimeString().substring(0, 5);
        
        document.getElementById('originalPrice').value = parseFloat(data.massage_plan_original_price).toFixed(0);
        document.getElementById('discountPrice').value = parseFloat(data.discount_price).toFixed(0);
        document.getElementById('notes').value = data.notes || '';
        
        updateSavings();
        
        isEditMode = true;
        currentInvitationId = id;
        
        saveBtn.innerHTML = '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708L9.708 9H9a.5.5 0 0 1-.5-.5v-.708l5.146-5.146z"/><path fill-rule="evenodd" d="M3 5a2 2 0 0 1 2-2h1.586l2 2H5a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V9.414l2-2V11a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5z"/></svg> æ›´æ–°é‚€è«‹';
        
        modal.classList.add('show');
        setTimeout(() => {
            document.getElementById('massagePlan').focus();
        }, 100);
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('è¼‰å…¥é‚€è«‹è³‡æ–™å¤±æ•—', 'error');
    });
}

// Save invitation
function saveInvitation() {
    const form = document.getElementById('invitationForm');
    const saveBtn = document.getElementById('saveBtn');
    
    // Validate form
    const massagePlan = document.getElementById('massagePlan').value;
    const therapist = document.getElementById('therapist').value;
    const invitationDate = document.getElementById('invitationDate').value;
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    const discountPrice = document.getElementById('discountPrice').value;
    
    if (!massagePlan) {
        showToast('è«‹é¸æ“‡æ–¹æ¡ˆ', 'error');
        document.getElementById('massagePlan').focus();
        return;
    }
    
    if (!therapist) {
        showToast('è«‹é¸æ“‡å¸«å‚…', 'error');
        document.getElementById('therapist').focus();
        return;
    }
    
    if (!invitationDate || !startTime || !endTime) {
        showToast('è«‹è¨­å®šå¸«å‚…å¯æœå‹™æ™‚é–“', 'error');
        return;
    }
    
    if (!discountPrice || discountPrice <= 0) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç‰¹åƒ¹', 'error');
        document.getElementById('discountPrice').focus();
        return;
    }
    
    // Check if end time is after start time
    if (endTime <= startTime) {
        showToast('çµæŸæ™‚é–“å¿…é ˆåœ¨é–‹å§‹æ™‚é–“ä¹‹å¾Œ', 'error');
        document.getElementById('endTime').focus();
        return;
    }
    
    showLoading(saveBtn);
    
    // Combine date and time
    const startDateTime = new Date(invitationDate + 'T' + startTime).toISOString();
    const endDateTime = new Date(invitationDate + 'T' + endTime).toISOString();
    
    const data = {
        massage_plan: parseInt(massagePlan),
        therapist: parseInt(therapist),
        available_start: startDateTime,
        available_end: endDateTime,
        discount_price: parseFloat(discountPrice),
        notes: document.getElementById('notes').value.trim()
    };

    const url = isEditMode 
        ? '/api/massage-invitations/' + currentInvitationId + '/'
        : '/api/massage-invitations/';
    
    const method = isEditMode ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        return response.text().then(text => {
            throw new Error('HTTP ' + response.status + ': ' + text);
        });
    })
    .then(data => {
        hideLoading(saveBtn);
        closeModal();
        showToast(isEditMode ? 'é‚€è«‹æ›´æ–°æˆåŠŸï¼' : 'é‚€è«‹å»ºç«‹æˆåŠŸï¼', 'success');
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    })
    .catch(error => {
        console.error('Error:', error);
        hideLoading(saveBtn);
        showToast('å„²å­˜å¤±æ•—ï¼š' + error.message, 'error');
    });
}

// Delete invitation
function deleteInvitation(id, planName) {
    const confirmMessage = "ç¢ºå®šè¦åˆªé™¤ã€Œ" + planName + "ã€çš„é‚€è«‹å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼";
    
    if (confirm(confirmMessage)) {
        fetch('/api/massage-invitations/' + id + '/', {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            return response.text().then(text => {
                throw new Error('HTTP ' + response.status + ': ' + text);
            });
        })
        .then(data => {
            showToast('é‚€è«‹åˆªé™¤æˆåŠŸï¼', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('åˆªé™¤å¤±æ•—ï¼š' + error.message, 'error');
        });
    }
}

// Copy invitation URL
function copyInvitationUrl(slug, id) {
    const baseUrl = window.location.origin;
    const invitationUrl = baseUrl + '/invitation/' + slug + '/';
    
    navigator.clipboard.writeText(invitationUrl).then(() => {
        const copyBtn = document.querySelector('#url-' + id + ' + .copy-btn');
        const originalText = copyBtn.textContent;
        
        copyBtn.textContent = 'å·²è¤‡è£½';
        copyBtn.classList.add('copied');
        
        setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.classList.remove('copied');
        }, 2000);
        
        showToast('é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
    }).catch(() => {
        showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½é€£çµ', 'error');
    });
}

// Filter functions
function applyFilters() {
    const therapistFilter = document.getElementById('therapistFilter').value;
    const planFilter = document.getElementById('planFilter').value;
    const startDateFilter = document.getElementById('startDateFilter').value;
    const endDateFilter = document.getElementById('endDateFilter').value;
    
    const cards = document.querySelectorAll('.invitation-card[data-therapist]');
    let visibleCount = 0;
    
    cards.forEach(card => {
        const therapist = card.getAttribute('data-therapist');
        const plan = card.getAttribute('data-plan');
        const cardStartDate = card.getAttribute('data-start-date');
        const cardEndDate = card.getAttribute('data-end-date');
        
        let show = true;
        
        if (therapistFilter && therapist !== therapistFilter) {
            show = false;
        }
        
        if (planFilter && plan !== planFilter) {
            show = false;
        }
        
        if (startDateFilter && cardStartDate < startDateFilter) {
            show = false;
        }
        
        if (endDateFilter && cardEndDate > endDateFilter) {
            show = false;
        }
        
        card.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    // Show empty state if no results
    updateEmptyState(visibleCount, cards.length);
}

// Quick filter
function quickFilter(type) {
    // Remove active class from all quick filter buttons
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to clicked button
    event.target.classList.add('active');
    
    const now = new Date();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const cards = document.querySelectorAll('.invitation-card[data-start-datetime]');
    let visibleCount = 0;
    
    cards.forEach(card => {
        const startTime = new Date(card.getAttribute('data-start-datetime'));
        const endTime = new Date(card.getAttribute('data-end-datetime'));
        
        let show = true;
        
        switch (type) {
            case 'today':
                // Show services available today
                show = startTime >= today && startTime < tomorrow;
                break;
            case 'upcoming':
                // Show future services
                show = startTime >= tomorrow;
                break;
            case 'past':
                // Show past services
                show = endTime < now;
                break;
            case 'all':
            default:
                show = true;
                break;
        }
        
        card.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    updateEmptyState(visibleCount, cards.length);
}

// Clear filters
function clearFilters() {
    document.getElementById('therapistFilter').value = '';
    document.getElementById('planFilter').value = '';
    document.getElementById('startDateFilter').value = '';
    document.getElementById('endDateFilter').value = '';
    
    // Reset quick filter to 'all'
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('.quick-filter-btn').classList.add('active');
    
    // Show all cards
    document.querySelectorAll('.invitation-card').forEach(card => {
        card.style.display = '';
    });
    
    updateEmptyState(document.querySelectorAll('.invitation-card[data-id]').length, 0);
}

// Update empty state
function updateEmptyState(visibleCount, totalCount) {
    const existingEmptyState = document.querySelector('.empty-state');
    const grid = document.getElementById('invitationsGrid');
    
    if (existingEmptyState) {
        existingEmptyState.remove();
    }
    
    if (visibleCount === 0 && totalCount > 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.innerHTML = `
            <div class="empty-icon">ğŸ”</div>
            <div class="empty-title">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„é‚€è«‹</div>
            <div class="empty-text">
                è«‹èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–æ¸…é™¤ç¯©é¸å™¨<br>
                ä¾†æŸ¥çœ‹æ›´å¤šé‚€è«‹
            </div>
            <button class="btn btn-secondary" onclick="clearFilters()">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                </svg>
                æ¸…é™¤ç¯©é¸
            </button>
        `;
        grid.appendChild(emptyState);
    }
}

// Loading states
function showLoading(button) {
    button.disabled = true;
    const originalHTML = button.innerHTML;
    button.setAttribute('data-original-html', originalHTML);
    button.innerHTML = `
        <div class="spinner"></div>
        è™•ç†ä¸­...
    `;
}

function hideLoading(button) {
    button.disabled = false;
    const originalHTML = button.getAttribute('data-original-html');
    if (originalHTML) {
        button.innerHTML = originalHTML;
    }
}

// Toast notifications
function showToast(message, type = 'success') {
    // Remove existing toast
    const existingToast = document.querySelector('.success-toast');
    if (existingToast) {
        existingToast.remove();
    }
    
    const toast = document.createElement('div');
    toast.className = 'success-toast';
    
    const icon = type === 'success' 
        ? `<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
             <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
           </svg>`
        : `<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
             <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
           </svg>`;
    
    if (type === 'error') {
        toast.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
    }
    
    toast.innerHTML = `${icon} ${message}`;
    
    document.body.appendChild(toast);
    
    // Trigger animation
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}
</script>
{% endblock %}