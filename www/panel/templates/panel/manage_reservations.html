{% extends 'panel/base.html' %}

{% block title %}預約管理{% endblock %}

{% block extra_css %}
<style>
    .reservations-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #eee;
        padding-bottom: 15px;
    }
    
    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #333;
        margin: 0;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-1px);
    }
    
    .btn-edit {
        background: #28a745;
        color: white;
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .btn-edit:hover {
        background: #218838;
        transform: translateY(-1px);
    }
    
    .btn-cancel {
        background: #dc3545;
        color: white;
        padding: 6px 12px;
        font-size: 12px;
        margin-left: 5px;
    }
    
    .btn-cancel:hover {
        background: #c82333;
        transform: translateY(-1px);
    }
    
    .btn-info {
        background: #17a2b8;
        color: white;
        padding: 6px 12px;
        font-size: 12px;
        margin-left: 5px;
    }
    
    .btn-info:hover {
        background: #138496;
        transform: translateY(-1px);
    }
    
    .reservations-table {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }
    
    .table th {
        background: #343a40;
        color: white;
        font-weight: 600;
        text-align: left;
        padding: 16px;
        border: none;
    }
    
    .table td {
        padding: 14px 16px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9ff;
    }
    
    .table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .actions {
        white-space: nowrap;
    }
    
    .customer-info {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }
    
    .customer-phone {
        font-size: 13px;
        color: #666;
    }
    
    .appointment-time {
        font-weight: 600;
        color: #007bff;
    }
    
    .appointment-date {
        font-size: 13px;
        color: #666;
    }
    
    .plan-name {
        font-weight: 600;
        color: #28a745;
        margin-bottom: 4px;
    }
    
    .plan-details {
        font-size: 13px;
        color: #666;
    }
    
    .therapist-name {
        font-weight: 600;
        color: #6f42c1;
    }
    
    .no-therapist {
        color: #999;
        font-style: italic;
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .status-upcoming {
        background: #e7f3ff;
        color: #0066cc;
    }
    
    .status-today {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-past {
        background: #f8d7da;
        color: #721c24;
    }
    
    /* Filters Section */
    .filters-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .filters-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }
    
    .filters-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    
    .filter-label {
        margin-bottom: 6px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }
    
    .filter-input,
    .filter-select {
        padding: 10px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s ease;
    }
    
    .filter-input:focus,
    .filter-select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    .quick-filters {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .quick-filter-btn {
        padding: 8px 16px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
    }
    
    .quick-filter-btn:hover,
    .quick-filter-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        background-color: white;
        margin: 3% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        transform: scale(0.9);
        opacity: 0;
        transition: all 0.3s ease;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal.show .modal-content {
        transform: scale(1);
        opacity: 1;
    }
    
    .modal-header {
        background: #343a40;
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }
    
    .close {
        color: white;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.3s ease;
    }
    
    .close:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .modal-body {
        padding: 30px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #333;
    }
    
    .form-control {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }
    
    .form-row {
        display: flex;
        gap: 15px;
    }
    
    .form-col {
        flex: 1;
    }
    
    .modal-footer {
        padding: 20px 30px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 16px;
    }
    
    .no-data svg {
        width: 64px;
        height: 64px;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    /* Stats Cards */
    .stats-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        padding: 20px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 14px;
        color: #666;
        font-weight: 500;
    }
    
    .stat-card.today .stat-value {
        color: #ffc107;
    }
    
    .stat-card.upcoming .stat-value {
        color: #007bff;
    }
    
    .stat-card.total .stat-value {
        color: #28a745;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .reservations-container {
            padding: 10px;
        }
        
        .page-header {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }
        
        .filters-row {
            grid-template-columns: 1fr;
        }
        
        .form-row {
            flex-direction: column;
        }
        
        .table th,
        .table td {
            padding: 10px 8px;
            font-size: 14px;
        }
        
        .modal-content {
            margin: 5% auto;
            width: 95%;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .btn-edit,
        .btn-info,
        .btn-cancel {
            margin-left: 0;
        }
    }
    
    @media (max-width: 480px) {
        .table th:nth-child(4),
        .table td:nth-child(4),
        .table th:nth-child(5),
        .table td:nth-child(5) {
            display: none;
        }
        
        .stats-section {
            grid-template-columns: 1fr 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="reservations-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">預約管理</h1>
        <button class="btn btn-primary" onclick="openModal('add')">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            新增預約
        </button>
    </div>

    <!-- Statistics Section -->
    <div class="stats-section">
        <div class="stat-card today">
            <div class="stat-value" id="todayCount">-</div>
            <div class="stat-label">今日預約</div>
        </div>
        <div class="stat-card upcoming">
            <div class="stat-value" id="upcomingCount">-</div>
            <div class="stat-label">未來預約</div>
        </div>
        <div class="stat-card total">
            <div class="stat-value" id="totalCount">{{ reservations|length }}</div>
            <div class="stat-label">總預約數</div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <h3 class="filters-title">搜尋與篩選</h3>
        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label" for="customerSearch">客戶姓名</label>
                <input type="text" class="filter-input" id="customerSearch" placeholder="搜尋客戶姓名..." onkeyup="filterReservations()">
            </div>
            <div class="filter-group">
                <label class="filter-label" for="phoneSearch">客戶電話</label>
                <input type="text" class="filter-input" id="phoneSearch" placeholder="搜尋電話號碼..." onkeyup="filterReservations()">
            </div>
            <div class="filter-group">
                <label class="filter-label" for="therapistFilter">師傅</label>
                <select class="filter-select" id="therapistFilter" onchange="filterReservations()">
                    <option value="">全部師傅</option>
                    {% for therapist in therapists %}
                    <option value="{{ therapist.id }}">{{ therapist.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label" for="planFilter">方案</label>
                <select class="filter-select" id="planFilter" onchange="filterReservations()">
                    <option value="">全部方案</option>
                    {% for plan in massage_plans %}
                    <option value="{{ plan.id }}">{{ plan.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label" for="startDate">開始日期</label>
                <input type="date" class="filter-input" id="startDate" onchange="filterReservations()">
            </div>
            <div class="filter-group">
                <label class="filter-label" for="endDate">結束日期</label>
                <input type="date" class="filter-input" id="endDate" onchange="filterReservations()">
            </div>
        </div>
        
        <div class="quick-filters">
            <span class="quick-filter-btn active" onclick="quickFilter('all')">全部預約</span>
            <span class="quick-filter-btn" onclick="quickFilter('today')">今日預約</span>
            <span class="quick-filter-btn" onclick="quickFilter('upcoming')">未來預約</span>
            <span class="quick-filter-btn" onclick="quickFilter('past')">過去預約</span>
            <button class="btn btn-secondary" onclick="clearFilters()" style="margin-left: auto;">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                </svg>
                清除篩選
            </button>
        </div>
    </div>

    <!-- Reservations Table -->
    <div class="reservations-table">
        <table class="table">
            <thead>
                <tr>
                    <th>客戶資訊</th>
                    <th>預約時間</th>
                    <th>方案</th>
                    <th>師傅</th>
                    <th>狀態</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="reservationsTableBody">
                {% for reservation in reservations %}
                <tr data-customer="{{ reservation.customer_name|lower }}" 
                    data-phone="{{ reservation.customer_phone }}" 
                    data-therapist="{{ reservation.therapist.id|default:"" }}" 
                    data-plan="{{ reservation.massage_plan.id }}"
                    data-date="{{ reservation.appointment_time|date:"Y-m-d" }}"
                    data-datetime="{{ reservation.appointment_time|date:"c" }}">
                    <td>
                        <div class="customer-info">{{ reservation.customer_name }}</div>
                        <div class="customer-phone">{{ reservation.customer_phone }}</div>
                    </td>
                    <td>
                        <div class="appointment-time">{{ reservation.appointment_time|date:"H:i" }}</div>
                        <div class="appointment-date">{{ reservation.appointment_time|date:"Y/m/d (l)" }}</div>
                    </td>
                    <td>
                        <div class="plan-name">{{ reservation.massage_plan.name }}</div>
                        <div class="plan-details">${{ reservation.massage_plan.price|floatformat:0 }} / {{ reservation.massage_plan.duration }}分鐘</div>
                    </td>
                    <td>
                        {% if reservation.therapist %}
                            <span class="therapist-name">{{ reservation.therapist.name }}</span>
                        {% else %}
                            <span class="no-therapist">未指定</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge" id="status-{{ reservation.id }}">-</span>
                    </td>
                    <td class="actions">
                        <button class="btn btn-info" onclick="viewReservation({{ reservation.id }})">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                            </svg>
                            查看
                        </button>
                        <button class="btn btn-edit" onclick="editReservation({{ reservation.id }})">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708L9.708 9H9a.5.5 0 0 1-.5-.5v-.708l5.146-5.146z"/>
                                <path fill-rule="evenodd" d="M3 5a2 2 0 0 1 2-2h1.586l2 2H5a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V9.414l2-2V11a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5z"/>
                            </svg>
                            編輯
                        </button>
                        <button class="btn btn-cancel" onclick="cancelReservation({{ reservation.id }}, '{{ reservation.customer_name|escapejs }}')">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                            </svg>
                            取消
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr id="noDataRow">
                    <td colspan="6" class="no-data">
                        <svg fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"/>
                        </svg>
                        <div>目前還沒有預約記錄</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Reservation Modal -->
<div id="reservationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">新增預約</h2>
            <button class="close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="reservationForm">
                {% csrf_token %}
                <input type="hidden" id="reservationId" name="id">
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="customerName">客戶姓名 *</label>
                            <input type="text" class="form-control" id="customerName" name="customer_name" required placeholder="請輸入客戶姓名">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="customerPhone">客戶電話 *</label>
                            <input type="tel" class="form-control" id="customerPhone" name="customer_phone" required placeholder="例如：0912345678">
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="appointmentDate">預約日期 *</label>
                            <input type="date" class="form-control" id="appointmentDate" name="appointment_date" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label class="form-label" for="appointmentTime">預約時間 *</label>
                            <input type="time" class="form-control" id="appointmentTime" name="appointment_time" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="massagePlan">選擇方案 *</label>
                    <select class="form-control" id="massagePlan" name="massage_plan" required>
                        <option value="">請選擇方案</option>
                        {% for plan in massage_plans %}
                        <option value="{{ plan.id }}" data-price="{{ plan.price }}" data-duration="{{ plan.duration }}">
                            {{ plan.name }} - ${{ plan.price|floatformat:0 }} ({{ plan.duration }}分鐘)
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="therapist">指定師傅</label>
                    <select class="form-control" id="therapist" name="therapist">
                        <option value="">不指定師傅（由店家安排）</option>
                        {% for therapist in therapists %}
                        <option value="{{ therapist.id }}">{{ therapist.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="saveReservation()">儲存</button>
        </div>
    </div>
</div>

<!-- View Reservation Modal -->
<div id="viewReservationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">預約詳情</h2>
            <button class="close" onclick="closeViewModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">客戶姓名</label>
                <div class="form-control" id="viewCustomerName" style="background: #f8f9fa; border: 1px solid #dee2e6;"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">客戶電話</label>
                <div class="form-control" id="viewCustomerPhone" style="background: #f8f9fa; border: 1px solid #dee2e6;"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">預約時間</label>
                <div class="form-control" id="viewAppointmentTime" style="background: #f8f9fa; border: 1px solid #dee2e6;"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">選擇方案</label>
                <div class="form-control" id="viewMassagePlan" style="background: #f8f9fa; border: 1px solid #dee2e6;"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">指定師傅</label>
                <div class="form-control" id="viewTherapist" style="background: #f8f9fa; border: 1px solid #dee2e6;"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">建立時間</label>
                <div class="form-control" id="viewCreatedAt" style="background: #f8f9fa; border: 1px solid #dee2e6;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// CSRF Token helper function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Modal management
let isEditMode = false;
let currentReservationId = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    updateStatusBadges();
    updateStatsCounts();
    setDefaultDate();
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('appointmentDate').min = today;
});

function updateStatusBadges() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    document.querySelectorAll('#reservationsTableBody tr[data-datetime]').forEach(row => {
        const appointmentTime = new Date(row.getAttribute('data-datetime'));
        const appointmentDate = new Date(appointmentTime.getFullYear(), appointmentTime.getMonth(), appointmentTime.getDate());
        const statusBadge = row.querySelector('.status-badge');
        
        if (appointmentDate.getTime() === today.getTime()) {
            statusBadge.textContent = '今日';
            statusBadge.className = 'status-badge status-today';
        } else if (appointmentTime > now) {
            statusBadge.textContent = '未來';
            statusBadge.className = 'status-badge status-upcoming';
        } else {
            statusBadge.textContent = '過去';
            statusBadge.className = 'status-badge status-past';
        }
    });
}

function updateStatsCounts() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    let todayCount = 0;
    let upcomingCount = 0;
    
    document.querySelectorAll('#reservationsTableBody tr[data-datetime]').forEach(row => {
        const appointmentTime = new Date(row.getAttribute('data-datetime'));
        const appointmentDate = new Date(appointmentTime.getFullYear(), appointmentTime.getMonth(), appointmentTime.getDate());
        
        if (appointmentDate.getTime() === today.getTime()) {
            todayCount++;
        } else if (appointmentTime > now) {
            upcomingCount++;
        }
    });
    
    document.getElementById('todayCount').textContent = todayCount;
    document.getElementById('upcomingCount').textContent = upcomingCount;
}

function setDefaultDate() {
    const today = new Date().toISOString().split('T')[0];
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    
    if (!startDateInput.value) {
        startDateInput.value = today;
    }
}

function openModal(mode) {
    const modal = document.getElementById('reservationModal');
    const modalTitle = document.getElementById('modalTitle');
    const form = document.getElementById('reservationForm');
    
    if (mode === 'add') {
        modalTitle.textContent = '新增預約';
        form.reset();
        isEditMode = false;
        currentReservationId = null;
        document.getElementById('reservationId').value = '';
        
        // Set default date and time
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        document.getElementById('appointmentDate').value = tomorrow.toISOString().split('T')[0];
        document.getElementById('appointmentTime').value = '10:00';
    }
    
    modal.style.display = 'block';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    document.getElementById('customerName').focus();
}

function closeModal() {
    const modal = document.getElementById('reservationModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

function closeViewModal() {
    const modal = document.getElementById('viewReservationModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

function editReservation(id) {
    // Fetch reservation data from API
    fetch(`/api/reservations/${id}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        const modal = document.getElementById('reservationModal');
        const modalTitle = document.getElementById('modalTitle');
        
        modalTitle.textContent = '編輯預約';
        
        // Fill form with existing data
        document.getElementById('reservationId').value = data.id;
        document.getElementById('customerName').value = data.customer_name;
        document.getElementById('customerPhone').value = data.customer_phone;
        
        // Parse appointment time
        const appointmentTime = new Date(data.appointment_time);
        document.getElementById('appointmentDate').value = appointmentTime.toISOString().split('T')[0];
        document.getElementById('appointmentTime').value = appointmentTime.toTimeString().substring(0, 5);
        
        document.getElementById('massagePlan').value = data.massage_plan;
        document.getElementById('therapist').value = data.therapist || '';
        
        isEditMode = true;
        currentReservationId = id;
        
        modal.style.display = 'block';
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
        
        document.getElementById('customerName').focus();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('載入預約資料失敗');
    });
}

function viewReservation(id) {
    // Fetch reservation data from API
    fetch(`/api/reservations/${id}/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        const modal = document.getElementById('viewReservationModal');
        
        // Fill view modal with data
        document.getElementById('viewCustomerName').textContent = data.customer_name;
        document.getElementById('viewCustomerPhone').textContent = data.customer_phone;
        
        const appointmentTime = new Date(data.appointment_time);
        document.getElementById('viewAppointmentTime').textContent = 
            appointmentTime.toLocaleDateString('zh-TW') + ' ' + 
            appointmentTime.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
        
        document.getElementById('viewMassagePlan').textContent = 
            `${data.massage_plan_name} - ${data.massage_plan_price} (${data.massage_plan_duration}分鐘)`;
        
        document.getElementById('viewTherapist').textContent = 
            data.therapist_name || '未指定師傅';
        
        const createdAt = new Date(data.created_at);
        document.getElementById('viewCreatedAt').textContent = 
            createdAt.toLocaleDateString('zh-TW') + ' ' + 
            createdAt.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
        
        modal.style.display = 'block';
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('載入預約資料失敗');
    });
}

function showLoading(button) {
    button.disabled = true;
    const originalText = button.innerHTML;
    button.setAttribute('data-original-text', originalText);
    button.innerHTML = '<svg class="animate-spin" width="16" height="16" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> 處理中...';
}

function hideLoading(button) {
    button.disabled = false;
    const originalText = button.getAttribute('data-original-text');
    button.innerHTML = originalText || '儲存';
}

function saveReservation() {
    const form = document.getElementById('reservationForm');
    const saveButton = document.querySelector('#reservationModal .btn-primary');
    
    // Validate form
    const customerName = document.getElementById('customerName').value.trim();
    const customerPhone = document.getElementById('customerPhone').value.trim();
    const appointmentDate = document.getElementById('appointmentDate').value;
    const appointmentTime = document.getElementById('appointmentTime').value;
    const massagePlan = document.getElementById('massagePlan').value;
    
    if (!customerName) {
        alert('請輸入客戶姓名');
        document.getElementById('customerName').focus();
        return;
    }
    
    if (!customerPhone) {
        alert('請輸入客戶電話');
        document.getElementById('customerPhone').focus();
        return;
    }
    
    if (!appointmentDate || !appointmentTime) {
        alert('請選擇預約日期和時間');
        return;
    }
    
    if (!massagePlan) {
        alert('請選擇方案');
        document.getElementById('massagePlan').focus();
        return;
    }
    
    showLoading(saveButton);
    
    // Combine date and time
    const appointmentDateTime = new Date(`${appointmentDate}T${appointmentTime}`).toISOString();
    
    const data = {
        customer_name: customerName,
        customer_phone: customerPhone,
        appointment_time: appointmentDateTime,
        massage_plan: parseInt(massagePlan),
        therapist: document.getElementById('therapist').value || null
    };

    const url = isEditMode 
        ? `/api/reservations/${currentReservationId}/`
        : '/api/reservations/';
    
    const method = isEditMode ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        return response.text().then(text => {
            throw new Error(`HTTP ${response.status}: ${text}`);
        });
    })
    .then(data => {
        hideLoading(saveButton);
        closeModal();
        showSuccessMessage(isEditMode ? '預約更新成功！' : '預約建立成功！');
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    })
    .catch(error => {
        console.error('Error:', error);
        hideLoading(saveButton);
        alert('儲存失敗：' + error.message);
    });
}

function cancelReservation(id, customerName) {
    const confirmMessage = `確定要取消 "${customerName}" 的預約嗎？\n\n此操作無法復原！`;
    
    if (confirm(confirmMessage)) {
        fetch(`/api/reservations/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            return response.text().then(text => {
                throw new Error(`HTTP ${response.status}: ${text}`);
            });
        })
        .then(data => {
            showSuccessMessage('預約取消成功！');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('取消失敗：' + error.message);
        });
    }
}

// Filter and Search Functions
function filterReservations() {
    const customerSearch = document.getElementById('customerSearch').value.toLowerCase();
    const phoneSearch = document.getElementById('phoneSearch').value;
    const therapistFilter = document.getElementById('therapistFilter').value;
    const planFilter = document.getElementById('planFilter').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    const rows = document.querySelectorAll('#reservationsTableBody tr[data-customer]');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const customer = row.getAttribute('data-customer');
        const phone = row.getAttribute('data-phone');
        const therapist = row.getAttribute('data-therapist');
        const plan = row.getAttribute('data-plan');
        const date = row.getAttribute('data-date');
        
        let show = true;
        
        // Customer name filter
        if (customerSearch && !customer.includes(customerSearch)) {
            show = false;
        }
        
        // Phone filter
        if (phoneSearch && !phone.includes(phoneSearch)) {
            show = false;
        }
        
        // Therapist filter
        if (therapistFilter && therapist !== therapistFilter) {
            show = false;
        }
        
        // Plan filter
        if (planFilter && plan !== planFilter) {
            show = false;
        }
        
        // Date range filter
        if (startDate && date < startDate) {
            show = false;
        }
        
        if (endDate && date > endDate) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    // Show/hide no data message
    const noDataRow = document.getElementById('noDataRow');
    if (noDataRow) {
        if (visibleCount === 0 && rows.length > 0) {
            noDataRow.style.display = '';
            noDataRow.children[0].innerHTML = `
                <svg fill="currentColor" viewBox="0 0 16 16" style="width: 64px; height: 64px; margin-bottom: 15px; opacity: 0.5;">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                </svg>
                <div>找不到符合條件的預約</div>
            `;
        } else {
            noDataRow.style.display = 'none';
        }
    }
}

function quickFilter(type) {
    // Remove active class from all quick filter buttons
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to clicked button
    event.target.classList.add('active');
    
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const rows = document.querySelectorAll('#reservationsTableBody tr[data-datetime]');
    
    rows.forEach(row => {
        const appointmentTime = new Date(row.getAttribute('data-datetime'));
        const appointmentDate = new Date(appointmentTime.getFullYear(), appointmentTime.getMonth(), appointmentTime.getDate());
        
        let show = true;
        
        switch (type) {
            case 'today':
                show = appointmentDate.getTime() === today.getTime();
                break;
            case 'upcoming':
                show = appointmentTime > now;
                break;
            case 'past':
                show = appointmentTime < now;
                break;
            case 'all':
            default:
                show = true;
                break;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('customerSearch').value = '';
    document.getElementById('phoneSearch').value = '';
    document.getElementById('therapistFilter').value = '';
    document.getElementById('planFilter').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    
    // Reset quick filter to 'all'
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector('.quick-filter-btn').classList.add('active');
    
    filterReservations();
}

function showSuccessMessage(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        z-index: 1001;
        animation: slideIn 0.3s ease;
    `;
    
    toast.innerHTML = `
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
        </svg>
        ${message}
    `;
    
    // Add animation styles if not already added
    if (!document.querySelector('style[data-toast-animations]')) {
        const style = document.createElement('style');
        style.setAttribute('data-toast-animations', 'true');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .animate-spin {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Close modals when clicking outside
    window.onclick = function(event) {
        const reservationModal = document.getElementById('reservationModal');
        const viewModal = document.getElementById('viewReservationModal');
        
        if (event.target == reservationModal) {
            closeModal();
        }
        if (event.target == viewModal) {
            closeViewModal();
        }
    }

    // Close modals with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
            closeViewModal();
        }
    });

    // Form submission with Enter key
    const form = document.getElementById('reservationForm');
    if (form) {
        form.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                saveReservation();
            }
        });
    }

    // Real-time search
    const customerSearchInput = document.getElementById('customerSearch');
    const phoneSearchInput = document.getElementById('phoneSearch');
    
    if (customerSearchInput) {
        let searchTimeout;
        customerSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterReservations, 300);
        });
    }
    
    if (phoneSearchInput) {
        let searchTimeout;
        phoneSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterReservations, 300);
        });
    }
});
</script>
{% endblock %}
