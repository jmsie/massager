{% extends 'panel/base.html' %}

{% block title %}管理按摩師{% endblock %}

{% block extra_css %}
<style>
    .therapists-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #eee;
        padding-bottom: 15px;
    }
    
    .page-title {
        font-size: 28px;
        font-weight: 700;
        color: #333;
        margin: 0;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-1px);
    }
    
    .btn-edit {
        background: #28a745;
        color: white;
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .btn-edit:hover {
        background: #218838;
        transform: translateY(-1px);
    }
    
    .btn-delete {
        background: #dc3545;
        color: white;
        padding: 6px 12px;
        font-size: 12px;
        margin-left: 5px;
    }
    
    .btn-delete:hover {
        background: #c82333;
        transform: translateY(-1px);
    }
    
    .therapists-table {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }
    
    .table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        text-align: left;
        padding: 16px;
        border: none;
    }
    
    .table td {
        padding: 14px 16px;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9ff;
    }
    
    .table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .actions {
        white-space: nowrap;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        transform: scale(0.9);
        opacity: 0;
        transition: all 0.3s ease;
    }
    
    .modal.show .modal-content {
        transform: scale(1);
        opacity: 1;
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
    }
    
    .close {
        color: white;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.3s ease;
    }
    
    .close:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .modal-body {
        padding: 30px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #333;
    }
    
    .form-control {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .modal-footer {
        padding: 20px 30px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 16px;
    }
    
    .no-data svg {
        width: 64px;
        height: 64px;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .therapists-container {
            padding: 10px;
        }
        
        .page-header {
            flex-direction: column;
            align-items: stretch;
            gap: 15px;
        }
        
        .table th,
        .table td {
            padding: 10px 8px;
            font-size: 14px;
        }
        
        .modal-content {
            margin: 10% auto;
            width: 95%;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="therapists-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">按摩師管理</h1>
        <button class="btn btn-primary" onclick="openModal('add')">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
            </svg>
            新增按摩師
        </button>
    </div>

    <!-- Therapists Table -->
    <div class="therapists-table">
        <table class="table">
            <thead>
                <tr>
                    <th>姓名</th>
                    <th>電話</th>
                    <th>Line ID</th>
                    <th>暱稱</th>
                    <th>建立時間</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for therapist in therapists %}
                <tr>
                    <td><strong>{{ therapist.name }}</strong></td>
                    <td>{{ therapist.phone|default:"-" }}</td>
                    <td>{{ therapist.line_id|default:"-" }}</td>
                    <td>{{ therapist.nick_name|default:"-" }}</td>
                    <td>{{ therapist.created_at|date:"Y-m-d H:i" }}</td>
                    <td class="actions">
                        <button class="btn btn-edit" onclick="editTherapist({{ therapist.id }}, '{{ therapist.name|escapejs }}', '{{ therapist.phone|default:""|escapejs }}', '{{ therapist.line_id|default:""|escapejs }}', '{{ therapist.nick_name|default:""|escapejs }}')">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708L9.708 9H9a.5.5 0 0 1-.5-.5v-.708l5.146-5.146z"/>
                                <path fill-rule="evenodd" d="M3 5a2 2 0 0 1 2-2h1.586l2 2H5a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V9.414l2-2V11a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5z"/>
                            </svg>
                            編輯
                        </button>
                        <button class="btn btn-delete" onclick="deleteTherapist({{ therapist.id }}, '{{ therapist.name|escapejs }}')">
                            <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                            </svg>
                            刪除
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="no-data">
                        <svg fill="currentColor" viewBox="0 0 16 16">
                            <path d="M14 1a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4.414A2 2 0 0 0 3 11.586l-2 2V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12.793a.5.5 0 0 0 .854.353L2.707 13H14a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                            <path d="M5 6a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                        </svg>
                        <div>目前還沒有按摩師資料</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div id="therapistModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalTitle">新增按摩師</h2>
            <button class="close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="therapistForm">
                {% csrf_token %}
                <input type="hidden" id="therapistId" name="id">
                
                <div class="form-group">
                    <label class="form-label" for="name">姓名 *</label>
                    <input type="text" class="form-control" id="name" name="name" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="phone">電話</label>
                    <input type="tel" class="form-control" id="phone" name="phone">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="line_id">Line ID</label>
                    <input type="text" class="form-control" id="line_id" name="line_id">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="nick_name">暱稱</label>
                    <input type="text" class="form-control" id="nick_name" name="nick_name">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="saveTherapist()">儲存</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// CSRF Token helper function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Modal management
let isEditMode = false;
let currentTherapistId = null;

function openModal(mode) {
    const modal = document.getElementById('therapistModal');
    const modalTitle = document.getElementById('modalTitle');
    const form = document.getElementById('therapistForm');
    
    if (mode === 'add') {
        modalTitle.textContent = '新增按摩師';
        form.reset();
        isEditMode = false;
        currentTherapistId = null;
        document.getElementById('therapistId').value = '';
    }
    
    modal.style.display = 'block';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    // Focus on first input
    document.getElementById('name').focus();
}

function closeModal() {
    const modal = document.getElementById('therapistModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

function editTherapist(id, name, phone, lineId, nickName) {
    const modal = document.getElementById('therapistModal');
    const modalTitle = document.getElementById('modalTitle');
    
    modalTitle.textContent = '編輯按摩師';
    
    // Fill form with existing data
    document.getElementById('therapistId').value = id;
    document.getElementById('name').value = name || '';
    document.getElementById('phone').value = phone || '';
    document.getElementById('line_id').value = lineId || '';
    document.getElementById('nick_name').value = nickName || '';
    
    isEditMode = true;
    currentTherapistId = id;
    
    modal.style.display = 'block';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    // Focus on name input
    document.getElementById('name').focus();
}

function showLoading(button) {
    button.disabled = true;
    const originalText = button.innerHTML;
    button.setAttribute('data-original-text', originalText);
    button.innerHTML = '<svg class="animate-spin" width="16" height="16" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> 處理中...';
}

function hideLoading(button) {
    button.disabled = false;
    const originalText = button.getAttribute('data-original-text');
    button.innerHTML = originalText || '儲存';
}

function saveTherapist() {
    const form = document.getElementById('therapistForm');
    const saveButton = document.querySelector('.modal-footer .btn-primary');
    
    // Validate form
    const nameInput = document.getElementById('name');
    if (!nameInput.value.trim()) {
        alert('請輸入姓名');
        nameInput.focus();
        return;
    }
    
    showLoading(saveButton);
    
    const formData = new FormData(form);
    
    const data = {
        name: formData.get('name').trim(),
        phone: formData.get('phone').trim(),
        line_id: formData.get('line_id').trim(),
        nick_name: formData.get('nick_name').trim()
    };

    const url = isEditMode 
        ? `/api/therapists/${currentTherapistId}/`
        : '/api/therapists/';
    
    const method = isEditMode ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        return response.text().then(text => {
            throw new Error(`HTTP ${response.status}: ${text}`);
        });
    })
    .then(data => {
        hideLoading(saveButton);
        closeModal();
        showSuccessMessage(isEditMode ? '更新成功！' : '新增成功！');
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    })
    .catch(error => {
        console.error('Error:', error);
        hideLoading(saveButton);
        alert('儲存失敗：' + error.message);
    });
}

function deleteTherapist(id, name) {
    const confirmMessage = `確定要刪除按摩師 "${name}" 嗎？\n\n此操作無法復原！`;
    
    if (confirm(confirmMessage)) {
        fetch(`/api/therapists/${id}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            return response.text().then(text => {
                throw new Error(`HTTP ${response.status}: ${text}`);
            });
        })
        .then(data => {
            showSuccessMessage('刪除成功！');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('刪除失敗：' + error.message);
        });
    }
}

function showSuccessMessage(message) {
    // Create success toast
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        z-index: 1001;
        animation: slideIn 0.3s ease;
    `;
    
    toast.innerHTML = `
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
        </svg>
        ${message}
    `;
    
    // Add animation styles if not already added
    if (!document.querySelector('style[data-toast-animations]')) {
        const style = document.createElement('style');
        style.setAttribute('data-toast-animations', 'true');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            .animate-spin {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(toast);
    
    // Remove toast after 3 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('therapistModal');
        if (event.target == modal) {
            closeModal();
        }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });

    // Form submission with Enter key
    const form = document.getElementById('therapistForm');
    if (form) {
        form.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                saveTherapist();
            }
        });
    }

    // Input validation
    const nameInput = document.getElementById('name');
    if (nameInput) {
        nameInput.addEventListener('input', function() {
            if (this.value.trim()) {
                this.style.borderColor = '#e0e0e0';
            }
        });
    }
});
</script>
{% endblock %}